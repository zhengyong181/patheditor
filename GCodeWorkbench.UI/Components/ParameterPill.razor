@namespace GCodeWorkbench.UI.Components

<div class="inline-flex items-center gap-0.5 bg-white/5 rounded px-1.5 py-0.5 hover:bg-white/10 transition-colors cursor-text group border border-transparent hover:border-white/20 @(IsEditing ? "border-primary bg-black/40" : "")"
     @onclick="StartEdit">
    
    <span class="font-bold @ColorClass text-[10px] select-none">@Label</span>
    
    @if (IsEditing)
    {
        <input @ref="_inputRef"
               value="@Value"
               @onchange="HandleChange"
               @onblur="StopEdit"
               @onkeydown="HandleKeyDown"
               class="w-12 bg-transparent text-white text-[10px] font-mono outline-none p-0 border-none m-0"
               autoFocus />
    }
    else
    {
        <span class="text-text-dim text-[10px] font-mono min-w-[2ch]">@(Value?.ToString("F3") ?? "")</span>
    }
</div>

@code {
    [Parameter] public string Label { get; set; } = "P";
    [Parameter] public double? Value { get; set; }
    [Parameter] public EventCallback<double?> ValueChanged { get; set; }
    [Parameter] public string ColorClass { get; set; } = "text-text-dim";
    [Parameter] public EventCallback OnCommit { get; set; }
    
    private bool IsEditing { get; set; }
    private ElementReference _inputRef;
    
    private async Task StartEdit()
    {
        if (!IsEditing)
        {
            IsEditing = true;
            await Task.Delay(50); // Wait for render
            try { await _inputRef.FocusAsync(); } catch {}
        }
    }
    
    private async Task HandleChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var val))
        {
            Value = val;
            await ValueChanged.InvokeAsync(val);
            await OnCommit.InvokeAsync();
        }
    }
    
    private void StopEdit()
    {
        IsEditing = false;
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            StopEdit();
        }
    }
}
